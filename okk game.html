<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Parkour Infinite Levels Game</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #87ceeb;
      font-family: Arial, sans-serif;
    }
    canvas {
      display: block;
    }
    #message {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 24px;
      font-weight: bold;
      color: white;
      text-shadow: 2px 2px 5px black;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    #levelText {
      position: absolute;
      top: 20px;
      width: 100%;
      text-align: center;
      font-size: 28px;
      font-weight: bold;
      color: white;
      text-shadow: 2px 2px 6px black;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <div id="message"></div>
  <div id="levelText">Level 1</div>
  
  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const keys = {};
    document.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
    document.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

    function showMessage(text) {
      const msg = document.getElementById("message");
      msg.innerText = text;
      msg.style.opacity = 1;
      setTimeout(() => msg.style.opacity = 0, 700);
    }

    // Player
    const player = {
      x: 100,
      y: 0,
      w: 40,
      h: 50,
      vx: 0,
      vy: 0,
      speed: 5,
      jumpPower: 15,
      onGround: false,
      jumpCount: 0,
      _jumpLock: false,
      spinTimer: 0
    };

    // Trail
    let trails = [];
    function spawnTrail(x, y) {
      for (let i = 0; i < 6; i++) {
        trails.push({
          x: x + Math.random() * 20 - 10,
          y: y + Math.random() * 20 - 10,
          r: 6 + Math.random() * 6,
          alpha: 1,
          life: 0.6
        });
      }
    }

    // World
    const gravity = 0.8;
    let blocks = [];
    let flag = null;
    let level = 1;
    const colors = ["#87ceeb","#ffa07a","#98fb98","#dda0dd","#f0e68c","#40e0d0"];

    function generateLevel(num) {
      blocks = [];
      let groundY = canvas.height - 40;
      blocks.push({ x: 0, y: groundY, w: 2000, h: 40 });
      let x = 300;
      for (let i=0; i<6+num; i++) {
        let w = 100 + Math.random()*100;
        let h = 20;
        let y = groundY - (100 + Math.random()*200);
        blocks.push({ x, y, w, h });
        x += 200 + Math.random()*200;
      }
      flag = { x: x+100, y: groundY-120, w: 20, h: 120, touched: false };
      player.x = 100; player.y = groundY-200; player.vx = 0; player.vy = 0;
      document.getElementById("levelText").innerText = "Level " + num;
      document.body.style.background = colors[num % colors.length];
    }

    const world = { camera: { x: 0, y: 0 } };

    function drawPlayer() {
      const p = player;
      for (let i = trails.length - 1; i >= 0; i--) {
        const t = trails[i];
        ctx.fillStyle = `rgba(255,255,200,${t.alpha})`;
        ctx.beginPath();
        ctx.arc(t.x - world.camera.x, t.y - world.camera.y, t.r, 0, Math.PI * 2);
        ctx.fill();
        t.life -= 0.016;
        t.alpha = t.life / 0.6;
        t.y += 30 * 0.016;
        if (t.life <= 0) trails.splice(i, 1);
      }

      ctx.save();
      ctx.translate(p.x + p.w / 2 - world.camera.x, p.y + p.h / 2 - world.camera.y);
      if (p.spinTimer > 0) {
        const angle = (0.6 - p.spinTimer) * Math.PI * 4;
        ctx.rotate(angle);
        p.spinTimer -= 0.016;
      }

      ctx.fillStyle = '#ffdf6e';
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.fillStyle = '#111';
      ctx.fillRect(p.w*0.15, -p.h*0.1, 3, 3);
      ctx.restore();
    }

    function drawBlocks() {
      ctx.fillStyle = "#444";
      blocks.forEach(b => {
        ctx.fillRect(b.x - world.camera.x, b.y - world.camera.y, b.w, b.h);
      });
    }

    function drawFlag() {
      ctx.fillStyle = flag.touched ? "green" : "red";
      ctx.fillRect(flag.x - world.camera.x, flag.y - world.camera.y, flag.w, flag.h);
    }

    function gameLoop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (keys["arrowright"] || keys["d"]) player.vx = player.speed;
      else if (keys["arrowleft"] || keys["a"]) player.vx = -player.speed;
      else player.vx = 0;

      const jumpPressed = keys[" "] || keys["w"] || keys["arrowup"];
      if (jumpPressed && !player._jumpLock) {
        if (player.onGround) {
          player.vy = -player.jumpPower;
          player.onGround = false;
          player.jumpCount = 1;
        } else if ((player.jumpCount || 0) < 2) {
          player.vy = -player.jumpPower * 0.9;
          player.jumpCount++;
          showMessage("Double Jump!");
          player.spinTimer = 0.6;
          spawnTrail(player.x, player.y);
        }
        player._jumpLock = true;
      }
      if (!jumpPressed) player._jumpLock = false;

      player.vy += gravity;
      player.x += player.vx;
      player.y += player.vy;

      player.onGround = false;
      blocks.forEach(b => {
        if (player.x < b.x + b.w &&
            player.x + player.w > b.x &&
            player.y < b.y + b.h &&
            player.y + player.h > b.y) {
          if (player.vy > 0 && player.y + player.h - player.vy <= b.y) {
            player.y = b.y - player.h;
            player.vy = 0;
            player.onGround = true;
            player.jumpCount = 0;
          }
        }
      });

      if (player.x + player.w > flag.x &&
          player.x < flag.x + flag.w &&
          player.y + player.h > flag.y &&
          player.y < flag.y + flag.h) {
        if (!flag.touched) {
          flag.touched = true;
          setTimeout(() => {
            level++;
            generateLevel(level);
          }, 500);
        }
      }

      world.camera.x = player.x - canvas.width / 2 + player.w / 2;
      world.camera.y = player.y - canvas.height / 2 + player.h / 2;

      drawBlocks();
      drawFlag();
      drawPlayer();

      requestAnimationFrame(gameLoop);
    }

    generateLevel(level);
    gameLoop();
  </script>
</body>
</html>
